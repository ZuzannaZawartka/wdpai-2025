<?php $pageTitle = isset($pageTitle) ? $pageTitle : 'SportMatch - Match Details'; $activeNav = $activeNav ?? 'sports'; ?>
<?php include __DIR__ . '/components/header.html'; ?>
<link rel="stylesheet" href="/public/styles/event.css" />

<?php
    $isAdmin = (($_SESSION['user_role'] ?? 'basic') === 'admin');
    $canSeeContact = $isAdmin || ($event['isOwner'] ?? false) || ($event['isUserParticipant'] ?? false);
?>

<section class="event-page">
    <div class="section">
        <div class="text-title-large">
            <?= htmlspecialchars($event['title'] ?? 'Match Details') ?>
        </div>
    </div>

    <div class="section panel">
        <div class="hero-map" aria-label="Map preview"
            data-location="<?= htmlspecialchars($event['coords'] ?? ($event['location'] ?? '')) ?>">
            <div id="eventLocationEmpty" class="hero-map-empty">
                <span class="material">location_on</span>
                <div class="text-small">No location available</div>
            </div>
            <div id="eventLocationPreview" class="location-preview" hidden>
                <div id="eventLocationMap" class="mini-map-canvas" aria-label="Event location preview"></div>
            </div>
        </div>

        <div class="details-grid">
            <div class="left">
                <div class="card panel">
                    <div class="text-title">Match Details</div>
                    <?php if (!empty($event['description'] ?? '')): ?>
                    <p class="text-body">
                        <?= nl2br(htmlspecialchars($event['description'])) ?>
                    </p>
                    <?php else: ?>
                    <p class="text-body text-note">No description provided.</p>
                    <?php endif; ?>
                    <div class="grid-info">
                        <div class="icon-row">
                            <span class="material">sports</span>
                            <span class="text-small">Sport</span>
                        </div>
                        <div class="text-small">
                            <?= htmlspecialchars($event['sportName'] ?? '') ?>
                        </div>
                        <div class="icon-row">
                            <span class="material">event</span>
                            <span class="text-small">Date &amp; Time</span>
                        </div>
                        <div class="text-small">
                            <?= htmlspecialchars($event['dateTime'] ?? '') ?>
                        </div>
                        <div class="icon-row">
                            <span class="material">signal_cellular_alt</span>
                            <span class="text-small">Skill Level</span>
                        </div>
                        <div class="text-small">
                            <?= htmlspecialchars($event['skillLevel'] ?? '') ?>
                        </div>
                    </div>
                </div>

                <div id="revealed-info" class="card panel" <?=$canSeeContact ? '' : 'hidden' ?>>
                    <div class="text-title">Location &amp; Contact</div>
                    <div class="grid-info">
                        <div class="icon-row">
                            <span class="material">pin_drop</span>
                            <span class="text-small">Exact Location</span>
                        </div>
                        <div class="text-small">
                            <?= htmlspecialchars(($event['coords'] ?? '') ?: ($event['location'] ?? '')) ?>
                        </div>
                        <div class="icon-row">
                            <span class="material">contact_mail</span>
                            <span class="text-small">Contact Organizer</span>
                        </div>
                        <div class="text-small">
                            <?php $orgEmail = (string)($event['organizer']['email'] ?? ''); ?>
                            <?php if ($orgEmail !== ''): ?>
                            <a class="a-link" href="mailto:<?= htmlspecialchars($orgEmail) ?>">
                                <?= htmlspecialchars($orgEmail) ?>
                            </a>
                            <?php else: ?>
                            <span class="text-note">Not available</span>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right">
                <div class="card panel">
                    <div class="text-title">Organizer</div>
                    <div class="organizer-info">
                        <?php
                            $organizerAvatar = (string)($event['organizer']['avatar'] ?? '');
                            if ($organizerAvatar === '') {
                                $organizerAvatar = DEFAULT_AVATAR;
                            }
                        ?>
                        <img src="<?= htmlspecialchars($organizerAvatar) ?>" alt="Organizer avatar"
                            class="organizer-avatar" />
                        <div>
                            <div class="text-title-smaller">
                                <?= htmlspecialchars($event['organizer']['name'] ?? '') ?>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card panel">
                    <div class="text-title">Participants</div>
                    <?php
                        $currentJoined = (int)($event['participants']['current'] ?? 0);
                        $maxPlayersRaw = $event['participants']['max'] ?? null;
                        $minNeededRaw = $event['participants']['minNeeded'] ?? null;

                        $maxPlayers = is_numeric($maxPlayersRaw) ? (int)$maxPlayersRaw : null;
                        if ($maxPlayers !== null && $maxPlayers <= 0) { $maxPlayers = null; }

                        $minNeeded = is_numeric($minNeededRaw) ? (int)$minNeededRaw : null;
                        if ($minNeeded !== null && $minNeeded <= 0) { $minNeeded = null; }

                        $participantsNote = '';
                        if ($minNeeded !== null && $maxPlayers !== null) {
                            // Range
                            $participantsNote = "Range: {$minNeeded}â€“{$maxPlayers} players";
                        } elseif ($minNeeded !== null) {
                            // Minimum
                            $participantsNote = "Minimum: {$minNeeded} players";
                        } elseif ($maxPlayers !== null) {
                            // Fixed number / limit
                            $participantsNote = "Players: {$maxPlayers}";
                        }
                    ?>
                    <div class="participants-stats">
                        <span class="material">groups</span>
                        <div class="text-small">
                            <?= $currentJoined ?>
                        </div>
                        <div class="text-small">
                            <?php if ($maxPlayers !== null): ?>
                            /
                            <?= $maxPlayers ?>
                            <?php endif; ?>
                            joined
                        </div>
                    </div>
                    <?php if ($participantsNote !== ''): ?>
                    <div class="text-note">
                        <span class="text-compact-strong">
                            <?= htmlspecialchars($participantsNote) ?>
                        </span>
                    </div>
                    <?php endif; ?>
                </div>
                <div class="join-actions">
                    <?php if ($event['isOwner'] ?? false): ?>
                    <a href="/edit/<?= (int)($event['id'] ?? 0) ?>" class="button accent text-size-small">Edit</a>
                    <button id="deleteBtn" class="button danger text-size-small"
                        data-event-id="<?= (int)($event['id'] ?? 0) ?>">Delete</button>
                    <?php elseif(($_SESSION['user_role'] ?? 'basic') === 'admin'): ?>
                    <!-- Admin can edit and delete any event -->
                    <a href="/edit/<?= (int)($event['id'] ?? 0) ?>" class="button accent text-size-small">Edit</a>
                    <button id="deleteBtn" class="button danger text-size-small"
                        data-event-id="<?= (int)($event['id'] ?? 0) ?>">Delete</button>
                    <?php else: ?>
                    <?php 
                        $isParticipant = $event['isUserParticipant'] ?? false; 
                        $isFull = $event['isFull'] ?? false;
                    ?>
                    <?php if ($isFull && !$isParticipant): ?>
                    <div class="button muted text-size-small" disabled style="cursor: not-allowed;">Event Full</div>
                    <?php else: ?>
                    <button id="joinBtn" class="button accent <?= $isParticipant ? 'hidden' : '' ?>"
                        data-event-id="<?= (int)($event['id'] ?? 0) ?>">Join Match</button>
                    <button id="cancelBtn" class="button muted text-size-small <?= $isParticipant ? '' : 'hidden' ?>"
                        data-event-id="<?= (int)($event['id'] ?? 0) ?>">Cancel Participation</button>
                    <?php endif; ?>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
</section>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    (function () {

        const wrap = document.querySelector('.hero-map');
        const locStr = wrap?.getAttribute('data-location')?.trim();
        const emptyEl = document.getElementById('eventLocationEmpty');
        const previewWrap = document.getElementById('eventLocationPreview');
        const canvasEl = document.getElementById('eventLocationMap');

        let map, marker;

        function ensurePreview(lat, lng) {
            if (!previewWrap || !canvasEl) return;
            previewWrap.removeAttribute('hidden');
            if (emptyEl && emptyEl.parentNode) {
                emptyEl.parentNode.removeChild(emptyEl);
            }
            if (!map) {
                map = L.map('eventLocationMap', {
                    zoomControl: false,
                    attributionControl: false,
                    scrollWheelZoom: false,
                    dragging: false,
                    doubleClickZoom: false,
                    boxZoom: false,
                    keyboard: false
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            }
            map.setView([lat, lng], 14);
            if (!marker) { marker = L.marker([lat, lng]).addTo(map); }
            else { marker.setLatLng([lat, lng]); }
            setTimeout(() => map.invalidateSize(), 0);
        }

        function tryParseLatLng(s) {
            if (!s) return null;
            const m = s.match(/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/);
            if (!m) return null;
            const lat = parseFloat(m[1]);
            const lng = parseFloat(m[2]);
            if (isFinite(lat) && isFinite(lng)) return { lat, lng };
            return null;
        }

        async function geocode(name) {
            try {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(name)}&format=json&limit=1`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) return null;
                const data = await res.json();
                if (Array.isArray(data) && data.length > 0) {
                    const { lat, lon } = data[0];
                    return { lat: parseFloat(lat), lng: parseFloat(lon) };
                }
            } catch (_) { }
            return null;
        }

        (async function initEventMap() {
            if (!wrap || !locStr) return;
            const coords = tryParseLatLng(locStr) || await geocode(locStr);
            if (coords) ensurePreview(coords.lat, coords.lng);
        })();

        const joinBtn = document.getElementById('joinBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const revealed = document.getElementById('revealed-info');

        function getEventId() {
            return joinBtn?.getAttribute('data-event-id') || cancelBtn?.getAttribute('data-event-id');
        }

        joinBtn?.addEventListener('click', function () {
            if (!confirm('Do you want to join this match?')) {
                return;
            }
            const eventId = getEventId();
            fetch(`/event/${eventId}/join`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        revealed?.removeAttribute('hidden');
                        joinBtn.classList.add('hidden');
                        cancelBtn?.classList.remove('hidden');
                    } else {
                        alert('Failed to join event');
                    }
                })
                .catch(err => alert('Error: ' + err.message));
        });

        cancelBtn?.addEventListener('click', function () {
            if (!confirm('Are you sure you want to cancel your participation?')) {
                return;
            }
            const eventId = getEventId();
            fetch(`/event/${eventId}/leave`, { method: 'POST', credentials: 'same-origin' })
                .then(async res => {
                    const text = await res.text();
                    try {
                        const data = JSON.parse(text);
                        if (data.status === 'success') {
                            cancelBtn.classList.add('hidden');
                            joinBtn?.classList.remove('hidden');
                            revealed?.setAttribute('hidden', '');
                        } else {
                            alert('Failed to leave event: ' + (data.message || ''));
                        }
                    } catch (e) {
                        console.error('Response is not valid JSON:', text);
                        alert('Error: Response is not valid JSON. See console for details.');
                    }
                })
                .catch(err => {
                    console.error('Network or JS error:', err);
                    alert('Error: ' + err.message);
                });
        });

        deleteBtn?.addEventListener('click', function () {
            const eventId = this.getAttribute('data-event-id');
            if (confirm('Are you sure you want to delete this event?')) {
                fetch(`/event/${eventId}/delete`, { method: 'POST', credentials: 'same-origin' })
                    .then(response => {
                        if (response.ok) {
                            // Redirect based on user role - admin goes to /sports, others to /my
                            const isAdmin = <?= json_encode((($_SESSION['user_role'] ?? 'basic') === 'admin')) ?>;
                            window.location.href = isAdmin ? '/sports' : '/my';
                        } else {
                            alert('Failed to delete event');
                        }
                    })
                    .catch(err => alert('Error deleting event: ' + err.message));
            }
        });
    })();
</script>

<?php include __DIR__ . '/components/footer.html'; ?>