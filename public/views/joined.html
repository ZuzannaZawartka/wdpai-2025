<?php $pageTitle = isset($pageTitle) ? $pageTitle : 'FindRival - Joined Events'; $activeNav = $activeNav ?? 'joined'; ?>
<?php include __DIR__ . '/components/header.html'; ?>

<section class="sports-page">
    <div class="section">
        <?php 
            $title = 'Joined Events';
            $description = "Here are the events you've signed up for. Manage your participation here.";
            include __DIR__ . '/components/page-header.html';
        ?>
    </div>

    <div class="section panel matches">
        <?php 
            $list = isset($joinedMatches) ? $joinedMatches : ($matches ?? []);
        ?>
        <?php if (!empty($list)): ?>
        <?php foreach($list as $m): ?>
        <?php
            $rowActions = '
                <a href="/event/'.(int)($m['id'] ?? 0).'" class="button primary small">View Details</a>';
            if (!($m['isOwner'] ?? false) && !($m['isPast'] ?? false)) {
                $rowActions .= '
                <button class="button danger small cancel-participation-joined"
                    data-event-id="'.(int)($m['id'] ?? 0).'">Cancel Participation</button>';
            }
            $isPast = $m['isPast'] ?? false;
            include __DIR__ . '/components/match-row.html';
        ?>
        <?php endforeach; ?>
        <?php else: ?>
        <?php 
            $emptyIcon = 'event_busy';
            $emptyTitle = "You haven't joined any events yet.";
            $emptyText = 'Time to find your next game and get in on the action!';
            $emptyLink = '/sports';
            $emptyLinkText = 'Find a Match';
            include __DIR__ . '/components/empty-state.html';
        ?>
        <?php endif; ?>
    </div>
</section>

<script>
    (function () {
        document.querySelectorAll('.cancel-participation-joined').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                if (!confirm('Are you sure you want to cancel your participation?')) {
                    return;
                }
                const eventId = this.getAttribute('data-event-id');
                fetch(`/event/${eventId}/leave`, { method: 'POST', credentials: 'same-origin' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            window.location.reload();
                        } else {
                            alert('Failed to leave event');
                        }
                    })
                    .catch(err => alert('Error: ' + err.message));
            });
        });
    })();
</script>

<?php include __DIR__ . '/components/footer.html'; ?>