<link rel="stylesheet" href="/public/styles/components/map-canvas.css">
<?php $pageTitle = isset($pageTitle) ? $pageTitle : 'FindRival - Create Event'; $activeNav = $activeNav ?? 'event-create'; ?>
<?php include __DIR__ . '/components/header.html'; ?>

<section class="create-page">
    <div class="section">
        <div class="text-title-large">Create Event</div>
        <p class="text-desc">Set up your match details below. You can upload an image, choose difficulty, set
            participant limits, pick a location on the map, and schedule the date and time.</p>
    </div>

    <div class="section panel">
        <?php 
            $mode = 'preview';
            $mapId = 'createPreviewMap';
            include __DIR__ . '/components/map.html';
        ?>

        <form class="form" method="post" action="#" enctype="multipart/form-data">
            <?php include __DIR__ . '/components/form-errors.html'; ?>
            <div class="form-grid">
                <div class="field input-group">
                    <label class="text-small" for="title">Event Name *</label>
                    <input id="title" name="title" type="text" class="input-common"
                        placeholder="e.g., Morning Basketball Game" required />
                </div>

                <div class="field input-group">
                    <label class="text-small" for="datetime">Date & Time *</label>
                    <div class="control with-icon">
                        <input id="datetime" name="datetime" type="datetime-local" class="input-common" required />
                    </div>
                </div>

                <div class="field input-group">
                    <label class="text-small" for="locationDisplay">Location</label>
                    <div class="control with-icon has-action">
                        <span class="material">location_on</span>
                        <input id="locationDisplay" name="locationDisplay" type="text" class="input-common"
                            placeholder="Pick on map" readonly />
                        <button type="button" class="icon-btn pick-map" data-target="createPickerMap">
                            <span class="material">my_location</span>
                        </button>
                    </div>
                    <?php 
                        $mode = 'picker';
                        $mapId = 'createPickerMap';
                        $previewId = 'createPreviewMap';
                        $inputName = 'location';
                        include __DIR__ . '/components/map.html';
                    ?>
                </div>

                <script>
                    (function () {
                        const mapInput = document.getElementById('input-createPickerMap');
                        const locDisplay = document.getElementById('locationDisplay');
                        const openBtn = document.querySelector('.pick-map[data-target="createPickerMap"]');
                        if (mapInput && locDisplay) {
                            mapInput.addEventListener('change', () => {
                                locDisplay.value = mapInput.value;
                                openBtn?.classList.add('applied');
                            });
                        }
                    })();
                </script>

                <div class="field input-group file-field">
                    <label class="text-small" for="image">Event Image</label>
                    <input id="image" name="image" type="file" accept="image/*" class="input-common" />
                </div>

                <div class="field input-group full">
                    <label class="text-small">Sport *</label>
                    <?php
                        $tilesSports = $allSports ?? [];
                        $tilesType = 'radio';
                        $tilesName = 'sport';
                        $tilesSelected = $formData['sport'] ?? ($_POST['sport'] ?? null);
                        $tilesValueField = 'id';
                        $tilesWrapperClass = 'sports-tiles';
                        $tilesLabelClass = 'tile-sport';
                        $tilesLayout = 'sport';
                        $tilesRequired = true;
                        include __DIR__ . '/components/sports-tiles.html';
                    ?>
                </div>

                <div class="field input-group full">
                    <label class="text-small">Skill Level</label>
                    <div class="radio-tiles">
                        <?php $levelsFromCtrl = $skillLevels ?? ['Advanced','Intermediate','Beginner','For Fun','Just Started']; foreach($levelsFromCtrl as $i => $lvl): ?>
                        <label class="tile">
                            <input type="radio" name="skill" value="<?= htmlspecialchars($lvl) ?>" <?=$i===2? 'checked'
                                : '' ?> />
                            <span>
                                <?= htmlspecialchars($lvl) ?>
                            </span>
                        </label>
                        <?php endforeach; ?>
                    </div>
                </div>

                <div class="field input-group full">
                    <label class="text-small">Participants</label>
                    <div class="radio-tiles compact" id="participantsType">
                        <label class="tile">
                            <input type="radio" name="participantsType" value="specific" />
                            <span>Specific Number</span>
                        </label>
                        <label class="tile">
                            <input type="radio" name="participantsType" value="minimum" />
                            <span>Minimum</span>
                        </label>
                        <label class="tile">
                            <input type="radio" name="participantsType" value="range" checked />
                            <span>Range</span>
                        </label>
                    </div>
                    <div class="participants-inputs">
                        <div class="row hidden" data-mode="specific">
                            <label class="text-small" for="playersSpecific">Players</label>
                            <input id="playersSpecific" name="playersSpecific" type="number" min="0" step="1"
                                class="input-common" placeholder="e.g., 10" />
                        </div>
                        <div class="row hidden" data-mode="minimum">
                            <label class="text-small" for="playersMin">Minimum Players</label>
                            <input id="playersMin" name="playersMin" type="number" min="0" step="1" class="input-common"
                                placeholder="e.g., 6" />
                        </div>
                        <div class="row" data-mode="range">
                            <div class="half">
                                <label class="text-small" for="playersRangeMin">Min Players</label>
                                <input id="playersRangeMin" name="playersRangeMin" type="number" min="0" step="1"
                                    class="input-common" placeholder="e.g., 6" />
                            </div>
                            <div class="half">
                                <label class="text-small" for="playersRangeMax">Max Players</label>
                                <input id="playersRangeMax" name="playersRangeMax" type="number" min="0" step="1"
                                    class="input-common" placeholder="e.g., 12" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field input-group full">
                    <label class="text-small" for="desc">Description</label>
                    <textarea id="desc" name="desc" class="input-common" rows="5"
                        placeholder="Add details participants should know..."></textarea>
                </div>
            </div>

            <div class="form-actions">
                <a href="/my" class="button danger small">Cancel</a>
                <button type="submit" class="button primary small">Save Event</button>
            </div>
        </form>
    </div>
</section>

<script>
    (function () {
        // Participants mode toggle
        const typeWrap = document.getElementById('participantsType');
        const rows = document.querySelectorAll('.participants-inputs .row');
        function updateParticipants() {
            const val = typeWrap.querySelector('input[name="participantsType"]:checked')?.value;
            rows.forEach(r => {
                const mode = r.getAttribute('data-mode');
                if (mode === val) { r.classList.remove('hidden'); }
                else { r.classList.add('hidden'); }
            });
        }
        typeWrap?.addEventListener('change', updateParticipants);
        updateParticipants();
    })();
</script>

<?php include __DIR__ . '/components/footer.html'; ?>