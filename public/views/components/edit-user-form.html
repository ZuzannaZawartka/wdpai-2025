<link rel="stylesheet" href="/public/styles/components/map-canvas.css">

<?php 
    $isTargetAdmin = ($user['role'] ?? 'user') === 'admin';
    $currentUserId = $_SESSION['user_id'] ?? null;
    $targetUserId = $user['id'] ?? null;
    $isOwnProfile = ($currentUserId !== null && $targetUserId !== null && (int)$currentUserId === (int)$targetUserId);
    $currentUrl = $_SERVER['REQUEST_URI'];
    $isInsideAdminPanel = (strpos($currentUrl, 'accounts') !== false);
?>

<form id="editUserForm" class="form" method="post" enctype="multipart/form-data"
    action="<?= htmlspecialchars($currentUrl) ?>">

    <input type="hidden" name="id" value="<?= $targetUserId ?>">
    <input type="hidden" name="context" value="<?= $isInsideAdminPanel ? 'admin_panel' : 'user_profile' ?>">

    <?php if(isset($messages)): ?>
    <div class="messages">
        <?= $messages ?>
    </div>
    <?php endif; ?>

    <?php if($isTargetAdmin): ?>
    <div class="form-grid">
        <div class="field input-group">
            <label class="text-small" for="firstName">First Name</label>
            <input id="firstName" name="firstName" type="text" class="input-common"
                value="<?= htmlspecialchars($user['firstName'] ?? '') ?>" />
        </div>
        <div class="field input-group">
            <label class="text-small" for="lastName">Last Name</label>
            <input id="lastName" name="lastName" type="text" class="input-common"
                value="<?= htmlspecialchars($user['lastName'] ?? '') ?>" />
        </div>
        <div class="field input-group full">
            <label class="text-small" for="email">Email</label>
            <input id="email" name="email" type="email" class="input-common"
                value="<?= htmlspecialchars($user['email'] ?? '') ?>" readonly />
        </div>
        <div class="field input-group full">
            <label class="text-small" for="locationDisplayAdmin">Location</label>
            <div class="control with-icon has-action">
                <span class="material">location_on</span>
                <input id="locationDisplayAdmin" type="text" class="input-common"
                    value="<?= htmlspecialchars($user['location'] ?? '') ?>" />
                <button type="button" class="icon-btn pick-map" data-target="adminPickerMap">
                    <span class="material">my_location</span>
                </button>
            </div>
            <?php 
                $mode = 'picker';
                $mapId = 'adminPickerMap';
                $inputName = 'location';
                $location = $user['location'] ?? '';
                include __DIR__ . '/map.html';
            ?>
        </div>
    </div>
    <?php else: ?>
    <div class="form-grid">
        <div class="field input-group full">
            <label class="text-small" for="avatarFile">Avatar</label>
            <div class="avatar-row">
                <div class="avatar-container">
                    <div id="avatarCircle" class="avatar" role="img"
                        style="background-image: url('<?= htmlspecialchars($user['avatar'] ?? '/public/img/default-avatar.png') ?>');">
                    </div>
                    <button type="button" class="avatar-edit-btn"
                        onclick="document.getElementById('avatarFile').click()"><span
                            class="material">edit</span></button>
                </div>
                <div class="avatar-info">
                    <div class="text-title-smaller">Photo</div>
                    <p class="text-note">Visible for other users.</p>
                </div>
                <input id="avatarFile" name="avatar" type="file" accept="image/*" hidden
                    onchange="previewAvatar(this)" />
            </div>
        </div>
        <div class="field input-group">
            <label class="text-small" for="firstName">First Name</label>
            <input id="firstName" name="firstName" type="text" class="input-common"
                value="<?= htmlspecialchars($user['firstName'] ?? '') ?>" />
        </div>
        <div class="field input-group">
            <label class="text-small" for="lastName">Last Name</label>
            <input id="lastName" name="lastName" type="text" class="input-common"
                value="<?= htmlspecialchars($user['lastName'] ?? '') ?>" />
        </div>
        <div class="field input-group full">
            <label class="text-small" for="email">Email</label>
            <input id="email" name="email" type="email" class="input-common"
                value="<?= htmlspecialchars($user['email'] ?? '') ?>" readonly />
        </div>
        <div class="field input-group">
            <label class="text-small" for="birthDate">Date of Birth</label>
            <input id="birthDate" name="birthDate" type="date" class="input-common"
                value="<?= htmlspecialchars($user['birthDate'] ?? '') ?>" />
        </div>
        <div class="field input-group full">
            <label class="text-small" for="locationDisplay">Location</label>
            <div class="control with-icon has-action">
                <span class="material">location_on</span>
                <input id="locationDisplay" type="text" class="input-common"
                    value="<?= htmlspecialchars($user['location'] ?? '') ?>" />
                <button type="button" class="icon-btn pick-map" data-target="userPickerMap">
                    <span class="material">my_location</span>
                </button>
            </div>
            <?php 
                    $mode = 'picker';
                    $mapId = 'userPickerMap';
                    $inputName = 'location';
                    $location = $user['location'] ?? '';
                    include __DIR__ . '/map.html';
                ?>
        </div>
        <div class="field input-group full">
            <label class="text-small">Favorite Sports</label>
            <?php 
                    $tilesSports = $allSports ?? [];
                    $tilesSelected = $selectedSportIds ?? [];
                    $tilesType = 'checkbox'; 
                    $tilesName = 'favourite_sports[]'; 
                    include __DIR__ . '/sports-tiles.html'; 
                ?>
        </div>
    </div>
    <?php endif; ?>

    <div class="form-grid">
        <?php if($isOwnProfile): ?>
        <div class="field input-group">
            <label class="text-small" for="oldPassword">Current Password</label>
            <input id="oldPassword" name="oldPassword" type="password" class="input-common"
                placeholder="Required for changes" />
        </div>
        <?php endif; ?>
        <div class="field input-group">
            <label class="text-small" for="newPassword">New Password</label>
            <input id="newPassword" name="newPassword" type="password" class="input-common"
                placeholder="Min. 8 characters" />
        </div>
        <div class="field input-group">
            <label class="text-small" for="confirmPassword">Confirm Password</label>
            <input id="confirmPassword" name="confirmPassword" type="password" class="input-common"
                placeholder="Repeat new password" />
        </div>
    </div>

    <div class="form-grid">
        <a href="<?= $isInsideAdminPanel ? '/accounts' : '/profile' ?>" class="button danger text-size-small">Cancel</a>
        <button type="submit" class="button primary text-size-small">Save Changes</button>
    </div>
</form>

<script>
    (function () {
        // Handle User Picker
        const userSync = () => {
            const openBtn = document.querySelector('.pick-map[data-target="userPickerMap"]');
            const mapInput = document.getElementById('input-userPickerMap');
            const locDisplay = document.getElementById('locationDisplay');
            if (!mapInput || !locDisplay) return;

            mapInput.addEventListener('change', () => {
                locDisplay.value = mapInput.value;
                locDisplay.readOnly = true;
                openBtn?.classList.add('applied');
            });

            // Reverse sync
            locDisplay.addEventListener('input', () => {
                mapInput.value = locDisplay.value;
            });

            if (locDisplay.value.match(/^-?\d+\.\d+,\s*-?\d+\.\d+$/)) {
                locDisplay.readOnly = true;
                openBtn?.classList.add('applied');
            }
        };

        // Handle Admin Picker
        const adminSync = () => {
            const openBtn = document.querySelector('.pick-map[data-target="adminPickerMap"]');
            const mapInput = document.getElementById('input-adminPickerMap');
            const locDisplay = document.getElementById('locationDisplayAdmin');
            if (!mapInput || !locDisplay) return;

            mapInput.addEventListener('change', () => {
                locDisplay.value = mapInput.value;
                locDisplay.readOnly = true;
                openBtn?.classList.add('applied');
            });

            // Reverse sync
            locDisplay.addEventListener('input', () => {
                mapInput.value = locDisplay.value;
            });

            if (locDisplay.value.match(/^-?\d+\.\d+,\s*-?\d+\.\d+$/)) {
                locDisplay.readOnly = true;
                openBtn?.classList.add('applied');
            }
        };

        userSync();
        adminSync();
    })();

    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('avatarCircle').style.backgroundImage = `url('${e.target.result}')`;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>