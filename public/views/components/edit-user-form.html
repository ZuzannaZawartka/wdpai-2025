<form class="form" method="post" enctype="multipart/form-data" action="<?php
    if (isset($user['role']) && $user['role'] === 'admin' || isset($pageTitle) && strpos($pageTitle, 'Admin') !== false || (isset($activeNav) && $activeNav === 'admin')) {
        $editId = isset($user['id']) ? (int)$user['id'] : 0;
        echo " /accounts/edit/{$editId}"; } else { echo "/profile-update" ; } ?>">
    <?php if(isset($messages)): ?>
    <div class="messages">
        <?= $messages ?>
    </div>
    <?php endif; ?>

    <?php
    $isAdminAccount = ($user['role'] ?? 'user') === 'admin';
    if($isAdminAccount): ?>
    <div class="form-grid">
        <div class="field input-group">
            <label class="text-small" for="firstName">First Name</label>
            <input id="firstName" name="firstName" type="text" class="input-common" placeholder="First name"
                value="<?= isset($user['firstName']) ? htmlspecialchars($user['firstName']) : '' ?>" />
        </div>
        <div class="field input-group">
            <label class="text-small" for="lastName">Last Name</label>
            <input id="lastName" name="lastName" type="text" class="input-common" placeholder="Last name"
                value="<?= isset($user['lastName']) ? htmlspecialchars($user['lastName']) : '' ?>" />
        </div>
        <div class="field input-group">
            <label class="text-small" for="email">Email</label>
            <input id="email" name="email" type="email" class="input-common" placeholder="Email"
                value="<?= isset($user['email']) ? htmlspecialchars($user['email']) : '' ?>" readonly />
        </div>
    </div>
    <div class="form-grid">
        <a href="/accounts" class="button danger text-size-small">Cancel</a>
        <button type="submit" class="button primary text-size-small">Save Changes</button>
    </div>
    <?php else: ?>
    <div class="form-grid">
        <div class="field input-group full">
            <label class="text-small" for="avatarFile">Avatar</label>
            <div class="avatar-row">
                <div class="avatar-container">
                    <div id="avatarCircle" class="avatar" role="img" aria-label="Current avatar"
                        data-avatar-url="<?= isset($user['avatar']) && $user['avatar'] ? htmlspecialchars($user['avatar']) : (isset($user['avatar_url']) && $user['avatar_url'] ? htmlspecialchars($user['avatar_url']) : DEFAULT_AVATAR) ?>">
                    </div>
                    <button type="button" class="avatar-edit-btn" aria-label="Edit avatar">
                        <span class="material" aria-hidden="true">edit</span>
                    </button>
                </div>
                <div class="avatar-info">
                    <div class="text-title-smaller">Your Photo</div>
                    <p class="text-note">This will be displayed on your profile.</p>
                </div>
                <input id="avatarFile" name="avatar" type="file" accept="image/*" hidden />
                <script>
                    const avatarInput = document.getElementById('avatarFile');
                    const avatarCircle = document.getElementById('avatarCircle');
                    const initialAvatar = avatarCircle?.getAttribute('data-avatar-url');
                    if (initialAvatar) {
                        avatarCircle.style.backgroundImage = `url('${initialAvatar}')`;
                        avatarCircle.style.width = '6rem';
                        avatarCircle.style.height = '6rem';
                        avatarCircle.style.borderRadius = '9999px';
                        avatarCircle.style.backgroundSize = 'cover';
                        avatarCircle.style.backgroundPosition = 'center';
                        avatarCircle.style.border = '0.25rem solid var(--white)';
                        avatarCircle.style.boxShadow = '0 0 0 0.125rem var(--primary)';
                    }
                    const editBtn = document.querySelector('.avatar-edit-btn');
                    avatarInput?.addEventListener('change', function () {
                        const file = this.files?.[0];
                        if (file && avatarCircle) {
                            const url = URL.createObjectURL(file);
                            avatarCircle.style.backgroundImage = `url('${url}')`;
                        }
                    });
                    editBtn?.addEventListener('click', () => avatarInput?.click());
                    avatarCircle?.addEventListener('click', () => avatarInput?.click());
                </script>
            </div>
        </div>
        <div class="field input-group">
            <label class="text-small" for="firstName">First Name</label>
            <input id="firstName" name="firstName" type="text" class="input-common" placeholder="e.g., Alex"
                value="<?= isset($user['firstName']) ? htmlspecialchars($user['firstName']) : '' ?>" />
        </div>
        <div class="field input-group">
            <label class="text-small" for="lastName">Last Name</label>
            <input id="lastName" name="lastName" type="text" class="input-common" placeholder="e.g., Morgan"
                value="<?= isset($user['lastName']) ? htmlspecialchars($user['lastName']) : '' ?>" />
        </div>
        <div class="field input-group full">
            <label class="text-small" for="email">Email</label>
            <input id="email" name="email" type="email" class="input-common" placeholder="e.g., alex@example.com"
                value="<?= isset($user['email']) ? htmlspecialchars($user['email']) : '' ?>" readonly />
        </div>
        <div class="field input-group">
            <label class="text-small" for="birthDate">Date of Birth</label>
            <input id="birthDate" name="birthDate" type="date" class="input-common"
                value="<?= isset($user['birthDate']) ? htmlspecialchars($user['birthDate']) : '' ?>" />
        </div>
        <div class="field input-group full">
            <label class="text-small" for="location">Location</label>
            <div class="filters-bar">
                <div class="control with-icon has-action">
                    <span class="material">location_on</span>
                    <input id="location" name="location" type="text" class="input-common" placeholder="Enter Location"
                        value="<?= isset($user['location']) ? htmlspecialchars($user['location']) : '' ?>" />
                    <button type="button" class="icon-btn pick-map" aria-label="Pick location on map">
                        <span class="material">my_location</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="field input-group full">
            <label class="text-small">Favorite Sports</label>
            <?php
                    $tilesSports = $allSports ?? [];
                    $tilesType = 'checkbox';
                    $tilesName = 'favourite_sports[]';
                    $tilesSelected = $selectedSportIds ?? [];
                    $tilesValueField = 'id';
                    $tilesWrapperClass = 'sports-tiles';
                    $tilesLabelClass = 'tile-sport';
                    $tilesRequired = false;
                    include __DIR__ . '/sports-tiles.html';
                ?>
        </div>

        <?php
        $isOwnProfile = !isset($editId) || (isset($_SESSION['user_id']) && isset($editId) && (int)$editId === (int)$_SESSION['user_id']);
        ?>
        <?php if($isOwnProfile): ?>
        <div class="field input-group">
            <label class="text-small" for="oldPassword">Current Password</label>
            <input id="oldPassword" name="oldPassword" type="password" class="input-common"
                placeholder="Enter current password" maxlength="128" />
        </div>
        <?php endif; ?>
        <div class="field input-group">
            <label class="text-small" for="newPassword">New Password</label>
            <input id="newPassword" name="newPassword" type="password" class="input-common"
                placeholder="Enter new password" minlength="8" maxlength="128" />
        </div>
        <div class="field input-group">
            <label class="text-small" for="confirmPassword">Confirm New Password</label>
            <input id="confirmPassword" name="confirmPassword" type="password" class="input-common"
                placeholder="Repeat new password" minlength="8" maxlength="128" />
        </div>
    </div>
    <div class="form-grid">
        <a href="/profile" class="button danger text-size-small">Cancel</a>
        <button type="submit" class="button primary text-size-small">Save Changes</button>
    </div>
    <?php endif; ?>
</form>