<link rel="stylesheet" href="/public/styles/components/map-canvas.css">
<?php $pageTitle = isset($pageTitle) ? $pageTitle : 'SportMatch - Edit Event'; $activeNav = $activeNav ?? 'edit'; $isReadOnly = $isReadOnly ?? false; ?>
<?php include __DIR__ . '/components/header.html'; ?>

<?php if($isReadOnly): ?>
<section class="create-page">
    <div class="section panel">
        <div style="text-align: center;">
            <div class="text-title-large">Event in the Past</div>
            <p class="text-desc" style="margin: 15px 0;">This event's date has already passed. You cannot edit events
                that have already
                occurred.</p>
            <a href="/my" class="button accent">Back to My Events</a>
        </div>
    </div>
</section>
<?php else: ?>
<section class="create-page">
    <div class="section">
        <div class="text-title-large">Edit Event</div>
        <p class="text-desc">Update your match details. Location, date, skill and participants can be adjusted. Click
            save when done.</p>
    </div>

    <div class="section panel">
        <?php 
            $locationStr = $event['location'] ?? '';
            $mode = 'preview';
            $mapId = 'editPreviewMap';
            $location = $locationStr;
            include __DIR__ . '/components/map.html';
        ?>

        <form class="form" method="post" action="/event/edit/<?= htmlspecialchars($eventId ?? '') ?>"
            enctype="multipart/form-data">
            <?php include __DIR__ . '/components/form-errors.html'; ?>
            <div class="form-grid">
                <div class="field input-group">
                    <label class="text-small" for="title">Event Name</label>
                    <input id="title" name="title" type="text" class="input-common"
                        placeholder="e.g., Morning Basketball Game"
                        value="<?= htmlspecialchars($event['title'] ?? '') ?>" />
                </div>

                <div class="field input-group">
                    <label class="text-small" for="datetime">Date & Time</label>
                    <div class="control with-icon">
                        <input id="datetime" name="datetime" type="datetime-local" class="input-common"
                            value="<?= htmlspecialchars($event['datetime'] ?? '') ?>" />
                    </div>
                </div>

                <div class="field input-group">
                    <label class="text-small" for="locationDisplay">Location</label>
                    <div class="control with-icon has-action">
                        <span class="material">location_on</span>
                        <input id="locationDisplay" name="locationDisplay" type="text" class="input-common"
                            placeholder="Pick on map" readonly value="<?= htmlspecialchars($locationStr) ?>" />
                        <button type="button" class="icon-btn pick-map" data-target="editPickerMap">
                            <span class="material">my_location</span>
                        </button>
                    </div>
                    <?php 
                        $mode = 'picker';
                        $mapId = 'editPickerMap';
                        $previewId = 'editPreviewMap';
                        $location = $locationStr;
                        $inputName = 'location';
                        include __DIR__ . '/components/map.html';
                    ?>
                </div>

                <script>
                    (function () {
                        const mapInput = document.getElementById('input-editPickerMap');
                        const locDisplay = document.getElementById('locationDisplay');
                        const openBtn = document.querySelector('.pick-map[data-target="editPickerMap"]');
                        if (mapInput && locDisplay) {
                            mapInput.addEventListener('change', () => {
                                locDisplay.value = mapInput.value;
                                openBtn?.classList.add('applied');
                            });
                        }
                    })();
                </script>

                <div class="field input-group file-field">
                    <label class="text-small" for="image">Event Image</label>
                    <?php 
                            $imgUrl = $event['imageUrl'] ?? $event['image_url'] ?? null;
                            if (!empty($imgUrl)):
                        ?>
                    <div class="event-image-preview">
                        <img src="<?= htmlspecialchars($imgUrl) ?>" alt="Current event image"
                            class="event-image-thumb" />
                    </div>
                    <?php endif; ?>
                    <input id="image" name="image" type="file" accept="image/*" class="input-common" />
                </div>

                <div class="field input-group full">
                    <label class="text-small">Sport *</label>
                    <?php
                        $tilesSports = $allSports ?? [];
                        $tilesType = 'radio';
                        $tilesName = 'sport';
                        $tilesSelected = $formData['sport'] ?? ($event['sportId'] ?? null);
                        $tilesValueField = 'id';
                        $tilesWrapperClass = 'sports-tiles';
                        $tilesLabelClass = 'tile-sport';
                        $tilesLayout = 'sport';
                        $tilesRequired = true;
                        include __DIR__ . '/components/sports-tiles.html';
                    ?>
                </div>

                <div class="field input-group full">
                    <label class="text-small">Skill Level</label>
                    <div class="radio-tiles">
                        <?php 
                        $levelsFromCtrl = $skillLevels ?? []; 
                        foreach($levelsFromCtrl as $lvl): 
                            $lvlName = is_array($lvl) ? $lvl['name'] : $lvl;
                            $lvlColor = is_array($lvl) ? ($lvl['hex_color'] ?? '#9E9E9E') : '#9E9E9E';
                            $isSelected = ($event['skillLevel'] ?? '') === $lvlName;
                        ?>
                        <label class="tile">
                            <input type="radio" name="skill" value="<?= htmlspecialchars($lvlName) ?>" <?=$isSelected
                                ? 'checked' : '' ?> />
                            <span class="skill-label">
                                <i class="color-indicator"
                                    style="--level-color: <?= htmlspecialchars($lvlColor) ?>;"></i>
                                <?= htmlspecialchars($lvlName) ?>
                            </span>
                        </label>
                        <?php endforeach; ?>
                    </div>
                </div>

                <div class="field input-group full">
                    <label class="text-small">Participants</label>
                    <div class="radio-tiles compact" id="participantsType">
                        <label class="tile">
                            <input type="radio" name="participantsType" value="specific"
                                <?=(($event['participants']['type'] ?? '' )==='specific' ) ? 'checked' : '' ?> />
                            <span>Specific Number</span>
                        </label>
                        <label class="tile">
                            <input type="radio" name="participantsType" value="minimum"
                                <?=(($event['participants']['type'] ?? '' )==='minimum' ) ? 'checked' : '' ?> />
                            <span>Minimum</span>
                        </label>
                        <label class="tile">
                            <input type="radio" name="participantsType" value="range"
                                <?=(($event['participants']['type'] ?? 'range' )==='range' ) ? 'checked' : '' ?> />
                            <span>Range</span>
                        </label>
                    </div>
                </div>
                <div class="participants-inputs">
                    <div class="row" data-mode="specific">
                        <label class="text-small" for="playersSpecific">Players</label>
                        <input id="playersSpecific" name="playersSpecific" type="number" min="0" step="1"
                            class="input-common" placeholder="e.g., 10"
                            value="<?= htmlspecialchars((string)($event['participants']['specific'] ?? '')) ?>" />
                    </div>
                    <div class="row hidden" data-mode="minimum">
                        <label class="text-small" for="playersMin">Minimum Players</label>
                        <input id="playersMin" name="playersMin" type="number" min="0" step="1" class="input-common"
                            placeholder="e.g., 6"
                            value="<?= htmlspecialchars((string)($event['participants']['minimum'] ?? '')) ?>" />
                    </div>
                    <div class="row hidden" data-mode="range">
                        <div class="half">
                            <label class="text-small" for="playersRangeMin">Min Players</label>
                            <input id="playersRangeMin" name="playersRangeMin" type="number" min="0" step="1"
                                class="input-common" placeholder="e.g., 6"
                                value="<?= htmlspecialchars((string)($event['participants']['rangeMin'] ?? '')) ?>" />
                        </div>
                        <div class="half">
                            <label class="text-small" for="playersRangeMax">Max Players</label>
                            <input id="playersRangeMax" name="playersRangeMax" type="number" min="0" step="1"
                                class="input-common" placeholder="e.g., 12"
                                value="<?= htmlspecialchars((string)($event['participants']['rangeMax'] ?? '')) ?>" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="field input-group full">
                <label class="text-small" for="desc">Description</label>
                <textarea id="desc" name="desc" class="input-common" rows="5"
                    placeholder="Add details participants should know..."><?= htmlspecialchars($event['desc'] ?? '') ?></textarea>
            </div>
    </div>

    <div class="form-actions">
        <a href="/sports" class="button danger small">Cancel</a>
        <button type="submit" class="button primary small">Save</button>
    </div>
    </form>
    </div>
</section>

<script>
    (function () {
        // Participants mode toggle
        const typeWrap = document.getElementById('participantsType');
        const rows = document.querySelectorAll('.participants-inputs .row');
        function updateParticipants() {
            const val = typeWrap.querySelector('input[name="participantsType"]:checked')?.value;
            rows.forEach(r => {
                const mode = r.getAttribute('data-mode');
                if (mode === val) { r.classList.remove('hidden'); }
                else { r.classList.add('hidden'); }
            });
        }
        typeWrap?.addEventListener('change', updateParticipants);

        // Auto-select radio when user focuses a matching input
        const radioSpecific = typeWrap?.querySelector('input[value="specific"]');
        const radioMinimum = typeWrap?.querySelector('input[value="minimum"]');
        const radioRange = typeWrap?.querySelector('input[value="range"]');
        document.getElementById('playersSpecific')?.addEventListener('focus', () => {
            if (radioSpecific) { radioSpecific.checked = true; updateParticipants(); }
        });
        document.getElementById('playersMin')?.addEventListener('focus', () => {
            if (radioMinimum) { radioMinimum.checked = true; updateParticipants(); }
        });
        document.getElementById('playersRangeMin')?.addEventListener('focus', () => {
            if (radioRange) { radioRange.checked = true; updateParticipants(); }
        });
        document.getElementById('playersRangeMax')?.addEventListener('focus', () => {
            if (radioRange) { radioRange.checked = true; updateParticipants(); }
        });

        updateParticipants();
    })();
</script>
<?php endif; ?>

<?php include __DIR__ . '/components/footer.html'; ?>