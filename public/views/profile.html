<?php
$pageTitle = isset($pageTitle) ? $pageTitle : 'SportMatch - Profile';
$activeNav = $activeNav ?? 'profile';
$isAdmin = (($_SESSION['user_role'] ?? 'basic') === 'admin');

// View-model fallbacks (some controller error paths render with partial data)
$user = $user ?? [
    'firstName' => '',
    'lastName' => '',
    'email' => ($_SESSION['user_email'] ?? ''),
    'birthDate' => '',
    'age' => null,
    'location' => '',
    'latitude' => null,
    'longitude' => null,
    'avatar' => DEFAULT_AVATAR,
];
$allSports = $allSports ?? [];
$selectedSportIds = $selectedSportIds ?? [];
?>
<?php include __DIR__ . '/components/header.html'; ?>

<section class="profile-page sports-page">
    <div class="section">
        <div class="text-title-large">Profile Settings</div>
        <p class="text-desc">Manage your personal details and favorite sports.</p>
    </div>

    <div class="section panel">
        <form class="form" method="post" action="/profile-update" enctype="multipart/form-data">

            <?php if(isset($messages)): ?>
            <div class="messages">
                <?= $messages ?>
            </div>
            <?php endif; ?>

            <div class="form-grid">
                <div class="field input-group full">
                    <label class="text-small" for="avatarFile">Avatar</label>
                    <div class="avatar-row">
                        <div class="avatar-container">
                            <div id="avatarCircle" class="avatar" role="img" aria-label="Current avatar"
                                data-avatar-url="<?= isset($user['avatar']) && $user['avatar'] ? htmlspecialchars($user['avatar']) : DEFAULT_AVATAR ?>">
                            </div>
                            <button type="button" class="avatar-edit-btn" aria-label="Edit avatar">
                                <span class="material">edit</span>
                            </button>
                        </div>
                        <div class="avatar-info">
                            <div class="text-title-smaller">Your Photo</div>
                            <p class="text-note">This will be displayed on your profile.</p>
                        </div>
                        <input id="avatarFile" name="avatar" type="file" accept="image/*" hidden />
                    </div>
                </div>
                <div class="field input-group">
                    <label class="text-small" for="firstName">First Name</label>
                    <input id="firstName" name="firstName" type="text" class="input-common" placeholder="e.g., Alex"
                        value="<?= isset($user['firstName']) ? htmlspecialchars($user['firstName']) : '' ?>" />
                </div>
                <div class="field input-group">
                    <label class="text-small" for="lastName">Last Name</label>
                    <input id="lastName" name="lastName" type="text" class="input-common" placeholder="e.g., Morgan"
                        value="<?= isset($user['lastName']) ? htmlspecialchars($user['lastName']) : '' ?>" />
                </div>
                <div class="field input-group full">
                    <label class="text-small" for="email">Email</label>
                    <input id="email" name="email" type="email" class="input-common"
                        placeholder="e.g., alex@example.com"
                        value="<?= isset($user['email']) ? htmlspecialchars($user['email']) : '' ?>" readonly />
                </div>

                <?php if(($_SESSION['user_role'] ?? 'basic') !== 'admin'): ?>
                <div class="field input-group">
                    <label class="text-small" for="birthDate">Date of Birth</label>
                    <input id="birthDate" name="birthDate" type="date" class="input-common"
                        value="<?= isset($user['birthDate']) ? htmlspecialchars($user['birthDate']) : '' ?>" />
                </div>
                <?php if(isset($user['age']) && $user['age'] !== null): ?>
                <div class="field input-group">
                    <label class="text-small" for="age">Age</label>
                    <input id="age" type="text" class="input-common" value="<?= htmlspecialchars($user['age']) ?>"
                        readonly />
                </div>
                <?php endif; ?>
                <?php endif; ?>

                <?php if(($_SESSION['user_role'] ?? 'basic') !== 'admin'): ?>
                <div class="field input-group full">
                    <label class="text-small" for="location">Location</label>
                    <div class="filters-bar">
                        <div class="control with-icon has-action">
                            <span class="material">location_on</span>
                            <input id="location" name="location" type="text" class="input-common"
                                placeholder="Enter Location"
                                value="<?= isset($user['location']) ? htmlspecialchars($user['location']) : '' ?>" />
                            <button type="button" class="icon-btn pick-map" aria-label="Pick location on map">
                                <span class="material">my_location</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="field input-group full">
                    <label class="text-small">Favorite Sports</label>
                    <?php
                        $tilesSports = $allSports;
                        $tilesType = 'checkbox';
                        $tilesName = 'favourite_sports[]';
                        $tilesSelected = $selectedSportIds;
                        $tilesValueField = 'id';
                        $tilesWrapperClass = 'sports-tiles';
                        $tilesLabelClass = 'tile-sport';
                        $tilesLayout = 'sport';
                        $tilesRequired = false;
                        include __DIR__ . '/components/sports-tiles.html';
                    ?>

                </div>
                <?php endif; ?>
            </div>

            <?php if(($_SESSION['user_role'] ?? 'basic') !== 'admin'): ?>
            <div class="form-grid">
                <div class="field input-group full">
                    <label class="text-small">Change Password (leave empty to keep current)</label>
                </div>
                <div class="field input-group">
                    <label class="text-small" for="oldPassword">Current Password</label>
                    <input id="oldPassword" name="oldPassword" type="password" class="input-common"
                        placeholder="Enter current password" maxlength="128" />
                </div>
                <div class="field input-group">
                    <label class="text-small" for="newPassword">New Password</label>
                    <input id="newPassword" name="newPassword" type="password" class="input-common"
                        placeholder="Enter new password" minlength="8" maxlength="128" />
                </div>
                <div class="field input-group">
                    <label class="text-small" for="confirmPassword">Confirm New Password</label>
                    <input id="confirmPassword" name="confirmPassword" type="password" class="input-common"
                        placeholder="Repeat new password" minlength="8" maxlength="128" />
                </div>
            </div>
            <?php endif; ?>

            <?php if(!$isAdmin): ?>
            <div class="form-grid">
                <a href="/dashboard" class="button danger text-size-small">Cancel</a>
                <button type="submit" class="button primary text-size-small">Save Changes</button>
            </div>
            <?php else: ?>
            <div class="form-grid">
                <div class="text-note">Admin profile editing is disabled.</div>
            </div>
            <?php endif; ?>
        </form>
    </div>

    <!-- Map modal for picking location -->
    <div id="mapModal" class="map-modal" hidden>
        <div class="map-modal-backdrop"></div>
        <div class="map-modal-content">
            <div id="map" class="map-canvas" aria-label="Pick location on map"></div>
            <div class="map-actions">
                <button type="button" class="button muted close-map">Cancel</button>
                <button type="button" class="button primary apply-map">Use this location</button>
            </div>
        </div>
    </div>
</section>

<!-- Leaflet for map picking -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    (function () {
        const modal = document.getElementById('mapModal');
        const openBtns = document.querySelectorAll('.pick-map');
        const closeBtn = modal?.querySelector('.close-map');
        const applyBtn = modal?.querySelector('.apply-map');
        const locInput = document.getElementById('location');

        let map, marker, chosenLatLng;

        function ensureMap() {
            if (map) {
                map.invalidateSize();
                return;
            }

            // Parse current location from input
            const currentLoc = locInput?.value?.trim();
            let lat = 52.2297, lng = 21.0122; // Default

            if (currentLoc && currentLoc.includes(',')) {
                const parts = currentLoc.split(',').map(p => parseFloat(p.trim()));
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    lat = parts[0];
                    lng = parts[1];
                    chosenLatLng = { lat, lng };
                }
            }

            map = L.map('map').setView([lat, lng], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

            // Add marker if location exists
            if (chosenLatLng) {
                marker = L.marker([lat, lng]).addTo(map);
            }

            map.on('click', (e) => {
                chosenLatLng = e.latlng;
                if (!marker) { marker = L.marker(e.latlng).addTo(map); }
                else { marker.setLatLng(e.latlng); }
            });
        }
        function openModal(e) { e?.preventDefault(); modal.removeAttribute('hidden'); setTimeout(ensureMap, 0); }
        function closeModal(e) { e?.preventDefault(); modal.setAttribute('hidden', ''); }
        function applyLocation(e) {
            e?.preventDefault();
            if (chosenLatLng && locInput) {
                locInput.value = `${chosenLatLng.lat.toFixed(5)}, ${chosenLatLng.lng.toFixed(5)}`;
                locInput.readOnly = true;
            }
            closeModal();
        }
        openBtns?.forEach(btn => btn.addEventListener('click', openModal));
        closeBtn?.addEventListener('click', closeModal);
        applyBtn?.addEventListener('click', applyLocation);
        modal?.querySelector('.map-modal-backdrop')?.addEventListener('click', closeModal);

        // Avatar preview and actions
        const avatarInput = document.getElementById('avatarFile');
        const avatarCircle = document.getElementById('avatarCircle');
        const initialAvatar = avatarCircle?.getAttribute('data-avatar-url');

        if (initialAvatar) {
            avatarCircle.style.backgroundImage = `url('${initialAvatar}')`;
        }
        const editBtn = document.querySelector('.avatar-edit-btn');

        avatarInput?.addEventListener('change', function () {
            const file = this.files?.[0];
            if (file && avatarCircle) {
                const url = URL.createObjectURL(file);
                avatarCircle.style.backgroundImage = `url('${url}')`;
            }
        });

        editBtn?.addEventListener('click', () => avatarInput?.click());

        // Avatar save handled with the main form submit
    })();
</script>

<?php include __DIR__ . '/components/footer.html'; ?>