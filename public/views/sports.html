<?php $pageTitle = isset($pageTitle) ? $pageTitle : 'SportMatch - Sports'; $activeNav = $activeNav ?? 'sports'; ?>
<?php include __DIR__ . '/components/header.html'; ?>

<section class="sports-page">
    <div class="section">
        <div class="text-title-large">Find your next game</div>
    </div>

    <div class="section panel filters-bar">
        <div class="control with-icon">
            <span class="material">workspace_premium</span>
            <?php $selectedLevel = $selectedLevel ?? 'Any'; ?>
            <select id="levelSelect" name="level" class="input-common">
                <option value="Any" <?=($selectedLevel==='Any' ) ? 'selected' : '' ?>>Any Skill Level</option>
                <option value="Beginner" <?=($selectedLevel==='Beginner' ) ? 'selected' : '' ?>>Beginner</option>
                <option value="Intermediate" <?=($selectedLevel==='Intermediate' ) ? 'selected' : '' ?>>Intermediate
                </option>
                <option value="Advanced" <?=($selectedLevel==='Advanced' ) ? 'selected' : '' ?>>Advanced</option>
            </select>
        </div>
        <div class="control with-icon has-action">
            <span class="material">location_on</span>
            <?php $selectedLoc = $selectedLoc ?? ''; ?>
            <input id="filterLocation" name="loc" type="text" class="input-common" placeholder="Enter Location"
                value="<?= htmlspecialchars($selectedLoc) ?>" />
            <button type="button" class="icon-btn pick-map" aria-label="Wybierz lokalizacjƒô na mapie">
                <span class="material">my_location</span>
            </button>
        </div>
        <div class="control with-icon radius">
            <span class="material">straighten</span>
            <?php $radiusKm = isset($radiusKm) ? (int)$radiusKm : 10; ?>
            <input id="radiusRange" name="radius" type="range" class="input-range" min="1" max="50"
                value="<?= $radiusKm ?>" aria-label="Radius in kilometers" />
            <span class="range-display text-small">
                <?= (int)$radiusKm ?> km
            </span>
        </div>
        <div class="control">
            <a href="/sports" id="clearLocation" class="a-link text-size-small">Clear location</a>
        </div>
        <div class="control" style="margin-left:auto">
            <a href="/sports" id="clearAllFilters" class="a-link text-size-small">Clear all</a>
        </div>

    </div>

    <div class="section select-row">
        <?php
            $tilesSports = $sportsGrid ?? [];
            $tilesType = 'checkbox';
            $tilesName = 'sport[]';
            $tilesSelected = $selectedSports ?? [];
            $tilesValueField = 'name';
            $tilesWrapperClass = 'grid-quick';
            $tilesLabelClass = 'tile selectable';
            $tilesLayout = 'quick';
            $tilesRequired = false;
            include __DIR__ . '/components/sports-tiles.html';
        ?>
        <button type="button" id="applySportsFilter" class="button primary text-size-small">
            <span>Search Events</span>
        </button>
    </div>

    <!-- Map modal for picking location -->
    <div id="mapModal" class="map-modal" hidden>
        <div class="map-modal-backdrop"></div>
        <div class="map-modal-content">
            <div id="map" class="map-canvas" aria-label="Pick location on map"></div>
            <div class="map-actions">
                <button type="button" class="button muted close-map">Cancel</button>
                <button type="button" class="button primary apply-map">Use this location</button>
            </div>
        </div>
    </div>

    <!-- Leaflet for map picking -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        (function () {
            const modal = document.getElementById('mapModal');
            const openBtn = document.querySelector('.pick-map');
            const closeBtn = modal?.querySelector('.close-map');
            const applyBtn = modal?.querySelector('.apply-map');
            const locInput = document.getElementById('filterLocation');
            const radiusEl = document.getElementById('radiusRange');
            const radiusDisplay = document.querySelector('.filters-bar .control.radius .range-display');
            let map, marker, chosenLatLng;

            function ensureMap() {
                if (map) { map.invalidateSize(); return; }
                map = L.map('map').setView([52.2297, 21.0122], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);
                map.on('click', (e) => {
                    chosenLatLng = e.latlng;
                    if (!marker) { marker = L.marker(e.latlng).addTo(map); }
                    else { marker.setLatLng(e.latlng); }
                });
            }

            function openModal(e) { e?.preventDefault(); modal.removeAttribute('hidden'); setTimeout(() => ensureMap(), 0); }
            function closeModal(e) { e?.preventDefault(); modal.setAttribute('hidden', ''); }
            function applyLocation(e) {
                e?.preventDefault();
                if (chosenLatLng && locInput) {
                    locInput.value = `${chosenLatLng.lat.toFixed(5)}, ${chosenLatLng.lng.toFixed(5)}`;
                    // Make location read-only to indicate it's chosen from map
                    locInput.readOnly = true;
                    // Visually indicate the icon button is applied
                    if (openBtn) {
                        openBtn.classList.add('applied');
                    }
                }
                closeModal();
            }

            openBtn?.addEventListener('click', openModal);
            closeBtn?.addEventListener('click', closeModal);
            applyBtn?.addEventListener('click', applyLocation);
            modal?.querySelector('.map-modal-backdrop')?.addEventListener('click', closeModal);

            // Radius display live update
            function updateRadiusDisplay() {
                if (radiusEl && radiusDisplay) {
                    radiusDisplay.textContent = `${radiusEl.value} km`;
                    const min = Number(radiusEl.min || 0);
                    const max = Number(radiusEl.max || 100);
                    const val = Number(radiusEl.value || min);
                    const pct = ((val - min) / (max - min)) * 100;
                    // Use numeric value for --range-pct, CSS multiplies by 1%
                    radiusEl.style.setProperty('--range-pct', `${pct}`);
                }
            }
            radiusEl?.addEventListener('input', updateRadiusDisplay);
            updateRadiusDisplay();
        })();
    </script>
    <script>
        (function () {
            const btn = document.getElementById('applySportsFilter');
            btn?.addEventListener('click', function (e) {
                e.preventDefault();
                const checked = Array.from(document.querySelectorAll('.select-row input[name="sport[]"]:checked'));
                const params = new URLSearchParams();
                checked.forEach(input => params.append('sport[]', input.value));
                const level = document.getElementById('levelSelect')?.value;
                if (level && level !== 'Any') {
                    params.set('level', level);
                }
                const locVal = document.getElementById('filterLocation')?.value?.trim();
                if (locVal) {
                    params.set('loc', locVal);
                    const r = document.getElementById('radiusRange')?.value;
                    if (r) params.set('radius', r);
                }
                const qs = params.toString();
                const url = qs ? ('/sports?' + qs) : '/sports';
                window.location.assign(url);
            });

            // Clear location only (preserve sports and level)
            const clearLoc = document.getElementById('clearLocation');
            clearLoc?.addEventListener('click', function (e) {
                e.preventDefault();
                const checked = Array.from(document.querySelectorAll('.select-row input[name="sport[]"]:checked'));
                const params = new URLSearchParams();
                checked.forEach(input => params.append('sport[]', input.value));
                const level = document.getElementById('levelSelect')?.value;
                if (level && level !== 'Any') {
                    params.set('level', level);
                }
                // Do not include loc/radius
                const qs = params.toString();
                const url = qs ? ('/sports?' + qs) : '/sports';
                window.location.assign(url);
            });

            // Clear all filters
            const clearAll = document.getElementById('clearAllFilters');
            clearAll?.addEventListener('click', function (e) {
                e.preventDefault();
                window.location.assign('/sports');
            });
        })();
    </script>

    <div class="section panel matches">
        <?php 
            $allMatches = $matches ?? [];
            $itemsPerPage = 10;
            $currentPage = isset($_GET['page']) ? max(1, (int)$_GET['page']) : 1;
            $totalItems = count($allMatches);
            $totalPages = max(1, ceil($totalItems / $itemsPerPage));
            $currentPage = min($currentPage, $totalPages);
            
            $offset = ($currentPage - 1) * $itemsPerPage;
            $pageMatches = array_slice($allMatches, $offset, $itemsPerPage);
        ?>
        <?php foreach($pageMatches as $m): ?>
        <article class="match <?= !empty($m['isPast']) ? 'past-event' : '' ?>">
            <div class="match-body">
                <div class="copy">
                    <div class="text-title-smaller">
                        <?= htmlspecialchars($m['title']) ?>
                    </div>
                    <p class="text-small">
                        <?= htmlspecialchars($m['datetime']) ?>
                    </p>
                    <p class="text-body">
                        <?= htmlspecialchars($m['desc']) ?>
                    </p>
                    <div class="meta-row text-small">
                        <span>üë•
                            <?= htmlspecialchars($m['players']) ?>
                        </span>
                        <span class="level" style="--level-color: <?= htmlspecialchars($m['levelColor']) ?>;">
                            <?= htmlspecialchars($m['level']) ?>
                        </span>
                    </div>
                    <a href="/event/<?= (int)($m['id'] ?? 0) ?>"
                        class="button primary text-size-small <?= !empty($m['isPast']) ? 'past' : '' ?>">View
                        Details</a>
                </div>
                <div class="visual" style="background-image:url('<?= htmlspecialchars($m['imageUrl']) ?>')"></div>
            </div>
        </article>
        <?php endforeach; ?>

        <?php if ($totalPages > 1): ?>
        <div class="pagination">
            <?php if ($currentPage > 1): ?>
            <?php 
                    $prevParams = $_GET;
                    $prevParams['page'] = $currentPage - 1;
                    $prevUrl = '?' . http_build_query($prevParams);
                ?>
            <a href="<?= htmlspecialchars($prevUrl) ?>" class="button muted">‚Üê Prev</a>
            <?php endif; ?>

            <div>
                <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                <?php if ($i === $currentPage): ?>
                <span class="button primary text-size-small">
                    <?= $i ?>
                </span>
                <?php else: ?>
                <?php 
                            $pageParams = $_GET;
                            $pageParams['page'] = $i;
                            $pageUrl = '?' . http_build_query($pageParams);
                        ?>
                <a href="<?= htmlspecialchars($pageUrl) ?>" class="button text-size-small">
                    <?= $i ?>
                </a>
                <?php endif; ?>
                <?php endfor; ?>
            </div>

            <?php if ($currentPage < $totalPages): ?>
            <?php 
                    $nextParams = $_GET;
                    $nextParams['page'] = $currentPage + 1;
                    $nextUrl = '?' . http_build_query($nextParams);
                ?>
            <a href="<?= htmlspecialchars($nextUrl) ?>" class="button muted">Next ‚Üí</a>
            <?php endif; ?>
        </div>
        <?php endif; ?>
    </div>
</section>

<?php include __DIR__ . '/components/footer.html'; ?>