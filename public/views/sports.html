<link rel="stylesheet" href="/public/styles/components/map-canvas.css">
<?php $pageTitle = isset($pageTitle) ? $pageTitle : 'SportMatch - Sports'; $activeNav = $activeNav ?? 'sports'; ?>
<?php include __DIR__ . '/components/header.html'; ?>

<section class="sports-page">
    <div class="section">
        <?php 
            $title = 'Find your next game';
            $description = 'Join local sports enthusiasts and play together.';
            include __DIR__ . '/components/page-header.html';
        ?>
    </div>

    <div class="section panel filters-bar">
        <div class="control with-icon">
            <span class="material">workspace_premium</span>
            <?php $selectedLevel = $selectedLevel ?? 'Any'; ?>
            <select id="levelSelect" name="level" class="input-common">
                <option value="Any" <?=($selectedLevel==='Any' ) ? 'selected' : '' ?>>Any Skill Level</option>
                <option value="Beginner" <?=($selectedLevel==='Beginner' ) ? 'selected' : '' ?>>Beginner</option>
                <option value="Intermediate" <?=($selectedLevel==='Intermediate' ) ? 'selected' : '' ?>>Intermediate
                </option>
                <option value="Advanced" <?=($selectedLevel==='Advanced' ) ? 'selected' : '' ?>>Advanced</option>
            </select>
        </div>
        <div class="control with-icon has-action">
            <span class="material">location_on</span>
            <?php $selectedLoc = $selectedLoc ?? ''; ?>
            <input id="filterLocation" name="loc" type="text" class="input-common" placeholder="Enter Location"
                value="<?= htmlspecialchars($selectedLoc) ?>" />
            <button type="button" class="icon-btn pick-map" data-target="sportsPickerMap"
                aria-label="Wybierz lokalizacjÄ™ na mapie">
                <span class="material">my_location</span>
            </button>
            <?php 
                $mode = 'picker';
                $mapId = 'sportsPickerMap';
                $inputName = 'loc';
                $location = $selectedLoc;
                include __DIR__ . '/components/map.html';
            ?>
        </div>
        <div class="control with-icon radius">
            <span class="material">straighten</span>
            <?php $radiusKm = isset($radiusKm) ? (int)$radiusKm : 10; ?>
            <input id="radiusRange" name="radius" type="range" class="input-range" min="1" max="50"
                value="<?= $radiusKm ?>" aria-label="Radius in kilometers" />
            <span class="range-display text-small">
                <?= (int)$radiusKm ?> km
            </span>
        </div>
        <div class="control">
            <a href="/sports" id="clearLocation" class="a-link text-size-small">Clear location</a>
        </div>
        <div class="control" style="margin-left:auto">
            <a href="/sports" id="clearAllFilters" class="a-link text-size-small">Clear all</a>
        </div>

    </div>

    <div class="section select-row">
        <?php
            $tilesSports = $sportsGrid ?? [];
            $tilesType = 'checkbox';
            $tilesName = 'sport[]';
            $tilesSelected = $selectedSports ?? [];
            $tilesValueField = 'name';
            $tilesWrapperClass = 'grid-quick';
            $tilesLabelClass = 'tile selectable';
            $tilesLayout = 'quick';
            $tilesRequired = false;
            include __DIR__ . '/components/sports-tiles.html';
        ?>
        <button type="button" id="applySportsFilter" class="button primary text-size-small">
            <span>Search Events</span>
        </button>
    </div>

    <script>
        (function () {
            const openBtn = document.querySelector('.pick-map[data-target="sportsPickerMap"]');
            const mapInput = document.getElementById('input-sportsPickerMap');
            const locInput = document.getElementById('filterLocation');
            const radiusEl = document.getElementById('radiusRange');
            const radiusDisplay = document.querySelector('.filters-bar .control.radius .range-display');


            if (mapInput && locInput) {
                mapInput.addEventListener('change', () => {
                    locInput.value = mapInput.value;
                    locInput.readOnly = true;
                    openBtn?.classList.add('applied');
                });


                if (locInput.value.match(/^-?\d+\.\d+,\s*-?\d+\.\d+$/)) {
                    locInput.readOnly = true;
                    openBtn?.classList.add('applied');
                }
            }


            function updateRadiusDisplay() {
                if (radiusEl && radiusDisplay) {
                    radiusDisplay.textContent = `${radiusEl.value} km`;
                    const min = Number(radiusEl.min || 0);
                    const max = Number(radiusEl.max || 100);
                    const val = Number(radiusEl.value || min);
                    const pct = ((val - min) / (max - min)) * 100;
                    radiusEl.style.setProperty('--range-pct', pct);
                }
            }
            radiusEl?.addEventListener('input', updateRadiusDisplay);
            updateRadiusDisplay();
        })();
    </script>



    <div class="section panel matches">
        <div id="matches-container">
            <div class="visual-state loading-state" style="display:none; padding: 2rem; text-align: center;">
                <span class="material spin">sync</span> Loading events...
            </div>
            <div class="visual-state empty-state" style="display:none; padding: 2rem; text-align: center;">
                <p>No events found matching your criteria.</p>
            </div>
        </div>
        <div id="pagination-container" style="text-align: center; margin-top: 1rem; display: none;"></div>
    </div>
</section>

<template id="match-template">
    <article class="match img-right">
        <div class="match-body">
            <div class="copy">
                <div class="text-title-smaller js-title"></div>
                <p class="text-small js-datetime"></p>
                <p class="text-body js-desc"></p>

                <div class="meta-row text-small">
                    <span><span class="material">groups</span><span class="js-players"></span></span>
                    <span class="level js-level-wrap">
                        <i class="color-indicator js-level-dot"></i>
                        <span class="js-level-name"></span>
                    </span>
                    <span class="js-sport-wrap" style="margin-left: 8px; display: flex; align-items: center; gap: 4px;">
                        <span class="material js-sport-icon" style="font-size: 16px;"></span>
                        <span class="js-sport-name"></span>
                    </span>
                </div>

                <div class="row-actions">
                    <a href="#" class="button primary small js-details-btn">View Details</a>
                </div>
            </div>
            <div class="visual js-bg"></div>
        </div>
    </article>
</template>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('matches-container');
        const loadingState = container.querySelector('.loading-state');
        const emptyState = container.querySelector('.empty-state');
        const template = document.getElementById('match-template');
        const paginationContainer = document.getElementById('pagination-container');
        let currentPage = 1;
        const limit = 6;

        fetchEvents();

        document.getElementById('applySportsFilter')?.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = 1;
            fetchEvents();
        });

        document.getElementById('levelSelect')?.addEventListener('change', () => {
            currentPage = 1;
            fetchEvents();
        });

        document.getElementById('radiusRange')?.addEventListener('change', () => {
            currentPage = 1;
            fetchEvents();
        });

        const locInput = document.getElementById('filterLocation');
        locInput?.addEventListener('change', () => {
            currentPage = 1;
            fetchEvents();
        });
        locInput?.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                currentPage = 1;
                fetchEvents();
            }
        });

        document.getElementById('clearLocation')?.addEventListener('click', (e) => {
            e.preventDefault();
            if (locInput) locInput.value = '';
            currentPage = 1;
            fetchEvents();
        });

        document.getElementById('clearAllFilters')?.addEventListener('click', (e) => {
            e.preventDefault();
            if (locInput) locInput.value = '';
            const levelSel = document.getElementById('levelSelect');
            if (levelSel) levelSel.value = 'Any';
            document.querySelectorAll('input[name="sport[]"]').forEach(el => el.checked = false);
            currentPage = 1;
            fetchEvents();
        });

        function fetchEvents() {
            Array.from(container.children).forEach(child => {
                if (!child.classList.contains('visual-state')) {
                    child.remove();
                }
            });

            const sports = Array.from(document.querySelectorAll('input[name="sport[]"]:checked')).map(el => el.value);
            const level = document.getElementById('levelSelect')?.value || 'Any';
            const loc = document.getElementById('filterLocation')?.value || '';
            const radius = document.getElementById('radiusRange')?.value || 10;

            const payload = {
                sports: sports,
                level: level,
                loc: loc,
                radius: radius,
                page: currentPage,
                limit: limit
            };

            loadingState.style.display = 'block';
            emptyState.style.display = 'none';
            paginationContainer.style.display = 'none';

            fetch('/api/sports/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(res => {
                    if (!res.ok) throw new Error('API Error');
                    return res.json();
                })
                .then(data => {
                    loadingState.style.display = 'none';
                    if (!data || !data.events || data.events.length === 0) {
                        if (currentPage === 1) emptyState.style.display = 'block';
                        return;
                    }

                    data.events.forEach(ev => renderEvent(ev));
                    renderPagination(data.total, data.totalPages, data.page);
                })
                .catch(err => {
                    console.error(err);
                    loadingState.style.display = 'none';
                });
        }

        function renderPagination(total, totalPages, activePage) {
            paginationContainer.innerHTML = '';
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }

            paginationContainer.style.display = 'block';

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = i;
                btn.className = 'button small ' + (i === activePage ? 'primary' : 'secondary');
                btn.style.margin = '0 0.25rem';
                btn.addEventListener('click', () => {
                    if (i !== currentPage) {
                        currentPage = i;
                        fetchEvents();
                    }
                });
                paginationContainer.appendChild(btn);
            }
        }

        function renderEvent(ev) {
            const clone = template.content.cloneNode(true);


            clone.querySelector('.js-title').textContent = ev.title;
            clone.querySelector('.js-datetime').textContent = ev.datetime;
            clone.querySelector('.js-desc').textContent = ev.desc || '';
            clone.querySelector('.js-players').textContent = ev.players;
            clone.querySelector('.js-level-name').textContent = ev.level;
            clone.querySelector('.js-sport-name').textContent = ev.sportName || '';
            clone.querySelector('.js-sport-icon').textContent = ev.sportIcon || 'sports_soccer';


            const levelDot = clone.querySelector('.js-level-dot');
            if (levelDot && ev.levelColor) {

                const levelWrap = clone.querySelector('.js-level-wrap');
                if (levelWrap) levelWrap.style.setProperty('--level-color', ev.levelColor);
            }

            const visual = clone.querySelector('.js-bg');
            if (visual && ev.imageUrl) {
                visual.style.backgroundImage = `url('${ev.imageUrl}')`;
            }

            const link = clone.querySelector('.js-details-btn');
            link.href = `/event/${ev.id}`;
            if (ev.isPast) {
                link.classList.add('past');
                clone.querySelector('.match').classList.add('past-event');
            }

            container.appendChild(clone);
        }

    });
</script>

<?php include __DIR__ . '/components/footer.html'; ?>