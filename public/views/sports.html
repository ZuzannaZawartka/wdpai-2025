<link rel="stylesheet" href="/public/styles/components/map-canvas.css">
<?php $pageTitle = isset($pageTitle) ? $pageTitle : 'SportMatch - Sports'; $activeNav = $activeNav ?? 'sports'; ?>
<?php include __DIR__ . '/components/header.html'; ?>

<section class="sports-page">
    <div class="section">
        <?php 
            $title = 'Find your next game';
            $description = 'Join local sports enthusiasts and play together.';
            include __DIR__ . '/components/page-header.html';
        ?>
    </div>

    <div class="section panel filters-bar">
        <div class="control with-icon">
            <span class="material">workspace_premium</span>
            <?php $selectedLevel = $selectedLevel ?? 'Any'; ?>
            <select id="levelSelect" name="level" class="input-common">
                <option value="Any" <?=($selectedLevel==='Any' ) ? 'selected' : '' ?>>Any Skill Level</option>
                <option value="Beginner" <?=($selectedLevel==='Beginner' ) ? 'selected' : '' ?>>Beginner</option>
                <option value="Intermediate" <?=($selectedLevel==='Intermediate' ) ? 'selected' : '' ?>>Intermediate
                </option>
                <option value="Advanced" <?=($selectedLevel==='Advanced' ) ? 'selected' : '' ?>>Advanced</option>
            </select>
        </div>
        <div class="control with-icon has-action">
            <span class="material">location_on</span>
            <?php $selectedLoc = $selectedLoc ?? ''; ?>
            <input id="filterLocation" name="loc" type="text" class="input-common" placeholder="Enter Location"
                value="<?= htmlspecialchars($selectedLoc) ?>" />
            <button type="button" class="icon-btn pick-map" data-target="sportsPickerMap"
                aria-label="Wybierz lokalizację na mapie">
                <span class="material">my_location</span>
            </button>
            <?php 
                $mode = 'picker';
                $mapId = 'sportsPickerMap';
                $inputName = 'loc';
                $location = $selectedLoc;
                include __DIR__ . '/components/map.html';
            ?>
        </div>
        <div class="control with-icon radius">
            <span class="material">straighten</span>
            <?php $radiusKm = isset($radiusKm) ? (int)$radiusKm : 10; ?>
            <input id="radiusRange" name="radius" type="range" class="input-range" min="1" max="50"
                value="<?= $radiusKm ?>" aria-label="Radius in kilometers" />
            <span class="range-display text-small">
                <?= (int)$radiusKm ?> km
            </span>
        </div>
        <div class="control">
            <a href="/sports" id="clearLocation" class="a-link text-size-small">Clear location</a>
        </div>
        <div class="control" style="margin-left:auto">
            <a href="/sports" id="clearAllFilters" class="a-link text-size-small">Clear all</a>
        </div>

    </div>

    <div class="section select-row">
        <?php
            $tilesSports = $sportsGrid ?? [];
            $tilesType = 'checkbox';
            $tilesName = 'sport[]';
            $tilesSelected = $selectedSports ?? [];
            $tilesValueField = 'name';
            $tilesWrapperClass = 'grid-quick';
            $tilesLabelClass = 'tile selectable';
            $tilesLayout = 'quick';
            $tilesRequired = false;
            include __DIR__ . '/components/sports-tiles.html';
        ?>
        <button type="button" id="applySportsFilter" class="button primary text-size-small">
            <span>Search Events</span>
        </button>
    </div>

    <script>
        (function () {
            const openBtn = document.querySelector('.pick-map[data-target="sportsPickerMap"]');
            const mapInput = document.getElementById('input-sportsPickerMap');
            const locInput = document.getElementById('filterLocation');
            const radiusEl = document.getElementById('radiusRange');
            const radiusDisplay = document.querySelector('.filters-bar .control.radius .range-display');

            // Synchronize the dummy display input with the hidden map input
            if (mapInput && locInput) {
                mapInput.addEventListener('change', () => {
                    locInput.value = mapInput.value;
                    locInput.readOnly = true;
                    openBtn?.classList.add('applied');
                    if (openBtn) {
                        openBtn.textContent = mapInput.value;
                    }
                });

                // If initial value is set and it's coords, make readonly
                if (locInput.value.match(/^-?\d+\.\d+,\s*-?\d+\.\d+$/)) {
                    locInput.readOnly = true;
                    openBtn?.classList.add('applied');
                }
            }

            // Radius display live update
            function updateRadiusDisplay() {
                if (radiusEl && radiusDisplay) {
                    radiusDisplay.textContent = `${radiusEl.value} km`;
                    const min = Number(radiusEl.min || 0);
                    const max = Number(radiusEl.max || 100);
                    const val = Number(radiusEl.value || min);
                    const pct = ((val - min) / (max - min)) * 100;
                    radiusEl.style.setProperty('--range-pct', pct);
                }
            }
            radiusEl?.addEventListener('input', updateRadiusDisplay);
            updateRadiusDisplay();
        })();
    </script>
    <script>
        (function () {
            const btn = document.getElementById('applySportsFilter');
            btn?.addEventListener('click', function (e) {
                e.preventDefault();
                const checked = Array.from(document.querySelectorAll('.select-row input[name="sport[]"]:checked'));
                const params = new URLSearchParams();
                checked.forEach(input => params.append('sport[]', input.value));
                const level = document.getElementById('levelSelect')?.value;
                if (level && level !== 'Any') {
                    params.set('level', level);
                }
                const locVal = document.getElementById('filterLocation')?.value?.trim();
                if (locVal) {
                    params.set('loc', locVal);
                    const r = document.getElementById('radiusRange')?.value;
                    if (r) params.set('radius', r);
                }
                const qs = params.toString();
                const url = qs ? ('/sports?' + qs) : '/sports';
                window.location.assign(url);
            });

            // Clear location only (preserve sports and level)
            const clearLoc = document.getElementById('clearLocation');
            clearLoc?.addEventListener('click', function (e) {
                e.preventDefault();
                const checked = Array.from(document.querySelectorAll('.select-row input[name="sport[]"]:checked'));
                const params = new URLSearchParams();
                checked.forEach(input => params.append('sport[]', input.value));
                const level = document.getElementById('levelSelect')?.value;
                if (level && level !== 'Any') {
                    params.set('level', level);
                }
                // Do not include loc/radius
                const qs = params.toString();
                const url = qs ? ('/sports?' + qs) : '/sports';
                window.location.assign(url);
            });

            // Clear all filters
            const clearAll = document.getElementById('clearAllFilters');
            clearAll?.addEventListener('click', function (e) {
                e.preventDefault();
                window.location.assign('/sports');
            });
        })();
    </script>

    <div class="section panel matches">
        <?php 
            $allMatches = $matches ?? [];
            $itemsPerPage = 10;
            $currentPage = isset($_GET['page']) ? max(1, (int)$_GET['page']) : 1;
            $totalItems = count($allMatches);
            $totalPages = max(1, ceil($totalItems / $itemsPerPage));
            $currentPage = min($currentPage, $totalPages);
            
            $offset = ($currentPage - 1) * $itemsPerPage;
            $pageMatches = array_slice($allMatches, $offset, $itemsPerPage);
        ?>
        <?php foreach($pageMatches as $m): ?>
        <?php
            $rowActions = '
                <a href="/event/'.(int)($m['id'] ?? 0).'"
                    class="button primary small '.(!empty($m['isPast']) ? 'past' : '').'">View Details</a>';
            $imagePosition = 'right';
            include __DIR__ . '/components/match-row.html';
        ?>
        <?php endforeach; ?>

        <?php if ($totalPages > 1): ?>
        <div class="pagination">
            <?php if ($currentPage > 1): ?>
            <?php 
                    $prevParams = $_GET;
                    $prevParams['page'] = $currentPage - 1;
                    $prevUrl = '?' . http_build_query($prevParams);
                ?>
            <a href="<?= htmlspecialchars($prevUrl) ?>" class="button muted">← Prev</a>
            <?php endif; ?>

            <div>
                <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                <?php if ($i === $currentPage): ?>
                <span class="button primary text-size-small">
                    <?= $i ?>
                </span>
                <?php else: ?>
                <?php 
                            $pageParams = $_GET;
                            $pageParams['page'] = $i;
                            $pageUrl = '?' . http_build_query($pageParams);
                        ?>
                <a href="<?= htmlspecialchars($pageUrl) ?>" class="button text-size-small">
                    <?= $i ?>
                </a>
                <?php endif; ?>
                <?php endfor; ?>
            </div>

            <?php if ($currentPage < $totalPages): ?>
            <?php 
                    $nextParams = $_GET;
                    $nextParams['page'] = $currentPage + 1;
                    $nextUrl = '?' . http_build_query($nextParams);
                ?>
            <a href="<?= htmlspecialchars($nextUrl) ?>" class="button muted">Next →</a>
            <?php endif; ?>
        </div>
        <?php endif; ?>
    </div>
</section>

<script>
    (function () {
        document.querySelectorAll('.matches .visual[data-bg]').forEach(el => {
            const url = (el.getAttribute('data-bg') || '').trim();
            if (!url) return;
            // Use double-quotes inside url() to avoid quoting issues
            el.style.backgroundImage = 'url("' + url.replace(/"/g, '\\"') + '")';
        });
    })();
</script>

<?php include __DIR__ . '/components/footer.html'; ?>